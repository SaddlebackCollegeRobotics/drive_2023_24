# Odrive S1 config. For the neos v1.1 motors. Firmware 0.6.8

odrv = odrv0
odrv.config.dc_bus_overvoltage_trip_level = 54
odrv.config.dc_bus_undervoltage_trip_level = 11.1
odrv.config.dc_max_positive_current = 50
odrv.config.dc_max_negative_current = -50
odrv.axis0.config.motor.motor_type = MotorType.HIGH_CURRENT
odrv.axis0.config.motor.torque_constant = 0.01748414376321353
odrv.axis0.config.motor.pole_pairs = 7
odrv.axis0.config.motor.current_soft_max = 40
odrv.axis0.config.motor.current_hard_max = 60
odrv.axis0.config.motor.calibration_current = 10
odrv.axis0.config.motor.resistance_calib_max_voltage = 2
odrv.axis0.config.calibration_lockin.current = 10

odrv.axis0.controller.config.control_mode = ControlMode.VELOCITY_CONTROL
odrv.axis0.controller.config.input_mode = InputMode.VEL_RAMP
odrv.axis0.controller.config.vel_ramp_rate = 150
odrv.axis0.controller.config.vel_limit = 100
odrv.axis0.controller.config.vel_limit_tolerance = 1.2  

# Disable spinout detection
odrv.axis0.controller.config.spinout_electrical_power_threshold = 9999
odrv.axis0.controller.config.spinout_mechanical_power_threshold = -9999

# Brake Resistor
odrv0.config.brake_resistor0.enable = True
odrv0.config.brake_resistor0.resistance = 2

# Previous
#odrv.axis0.config.torque_soft_min = -0.07214830970556162
#odrv.axis0.config.torque_soft_max = 0.07214830970556162

odrv.axis0.config.torque_soft_min = -0.25
odrv.axis0.config.torque_soft_max = 0.25

odrv.axis0.config.enable_watchdog = True
odrv.axis0.config.watchdog_timeout = 2

# PID Loop
# vel_integrator_gain = 0.5 * encoder_bandwidth?? * vel_gain
odrv.axis0.controller.config.vel_gain = 0.08
odrv.axis0.controller.config.vel_integrator_gain = 0.5 * 10 * odrv.axis0.controller.config.vel_gain

# TODO REMOVE
# odrv0.axis0.controller.config.vel_gain = 0.08
# odrv0.axis0.controller.config.vel_integrator_gain = 0.5 * 10 * 0.08
# odrv0.save_configuration()

odrv.axis0.config.encoder_bandwidth = 100
odrv.hall_encoder0.config.enabled = True
odrv.axis0.config.load_encoder = EncoderId.HALL_ENCODER0
odrv.axis0.config.commutation_encoder = EncoderId.HALL_ENCODER0

# Add can bus functionality
odrv.config.enable_can_a = True
odrv.axis0.config.can.node_id = 0
odrv.can.config.baud_rate = 1000000

# Enable cyclical data to reach over CAN
odrv.axis0.config.can.heartbeat_msg_rate_ms = 100
odrv.axis0.config.can.encoder_msg_rate_ms = 100
odrv.axis0.config.can.iq_msg_rate_ms = 100
odrv.axis0.config.can.torques_msg_rate_ms = 100
odrv.axis0.config.can.error_msg_rate_ms = 100
odrv.axis0.config.can.temperature_msg_rate_ms = 100
odrv.axis0.config.can.bus_voltage_msg_rate_ms = 100

odrv.save_configuration()
